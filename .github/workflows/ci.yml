name: CI

on:
  push:
    branches:
      - "**"
  pull_request:

permissions:
  contents: read

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4.1.7
        with:
          persist-credentials: false

      - name: Setup Python
        uses: actions/setup-python@v5.1.0
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: python -m pip install --upgrade pip && python -m pip install -r requirements.txt

      - name: Build C++ library
        run: make build

      - name: Run C++ unit tests
        run: make test-cpp

      - name: Run Python tests
        run: make test-py

      - name: Build native batch Python extension (Cython)
        env:
          QK_LIB_PATH: ${{ github.workspace }}/build/cpp
        run: |
          cd python
          python setup.py build_ext --inplace

      - name: Run deterministic batch/perf regression tests
        env:
          PYTHONPATH: python
          QK_LIB_PATH: ${{ github.workspace }}/build/cpp
          PYTHONHASHSEED: "0"
          OMP_NUM_THREADS: "1"
        run: |
          python -m pytest -q python/tests/test_batch_api.py python/tests/test_perf_regression.py

      - name: Generate benchmark comparison table
        env:
          PYTHONPATH: python
          QK_LIB_PATH: ${{ github.workspace }}/build/cpp
          PYTHONHASHSEED: "0"
          OMP_NUM_THREADS: "1"
        run: |
          cmake --build build -j 4 --target qk_bench_bsm_batch
          python python/examples/benchmark_scalar_batch_cpp.py --n 50000 --repeats 3 | tee benchmark_table.md
          cat benchmark_table.md >> "${GITHUB_STEP_SUMMARY}"

      - name: Configure fuzz tests
        run: cmake -S fuzztest -B build/fuzztest

      - name: Build fuzz test binaries
        run: cmake --build build/fuzztest -j 4

      - name: Run all fuzz test suites under fuzztest/
        timeout-minutes: 15
        shell: bash
        env:
          # Make fuzz/property runs deterministic in CI to avoid random-seed flakes.
          FUZZTEST_PRNG_SEED: NNMQpT7FLDG9rOgxXhD87HtvjqCtE-6NHWnDn00xICI
        run: |
          set -euo pipefail
          shopt -s nullglob
          sources=(fuzztest/fuzz_*.cpp)
          if (( ${#sources[@]} == 0 )); then
            echo "No fuzz sources found under fuzztest/"
            exit 1
          fi
          for src in "${sources[@]}"; do
            bin="$(basename "${src%.cpp}")"
            exe="./build/fuzztest/${bin}"
            echo "Running ${exe}"
            if [[ ! -x "${exe}" ]]; then
              echo "Expected fuzz binary not found: ${exe}"
              exit 1
            fi
            "${exe}"
          done
