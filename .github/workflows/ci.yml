name: CI

on:
  push:
    branches:
      - "**"
  pull_request:

permissions:
  contents: read

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4.1.7
        with:
          persist-credentials: false

      - name: Setup Python
        uses: actions/setup-python@v5.1.0
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: python -m pip install --upgrade pip && python -m pip install -r requirements.txt

      - name: Run API parity guard checks
        env:
          PYTHONPATH: python
        run: |
          python -m pytest -q python/tests/test_parity_guard.py

      - name: Build C++ library
        run: make build

      - name: Run C++ unit tests
        run: make test-cpp

      - name: Run Python tests
        env:
          PYTHONPATH: python
          QK_LIB_PATH: ${{ github.workspace }}/build/cpp
        run: |
          python -m pytest -q python/tests --ignore=python/tests/test_perf_regression.py --ignore=python/tests/test_batch_api.py

      - name: Run deterministic batch/perf regression tests
        env:
          PYTHONPATH: python
          QK_LIB_PATH: ${{ github.workspace }}/build/cpp
          PYTHONHASHSEED: "0"
          OMP_NUM_THREADS: "1"
        run: |
          python -m pytest -q python/tests/test_batch_api.py python/tests/test_perf_regression.py

      - name: Generate benchmark comparison table
        env:
          PYTHONPATH: python
          QK_LIB_PATH: ${{ github.workspace }}/build/cpp
          PYTHONHASHSEED: "0"
          OMP_NUM_THREADS: "1"
        run: |
          cmake --build build -j 4 --target qk_bench_bsm_batch
          python examples/benchmark_scalar_batch_cpp.py --n 50000 --repeats 3 | tee benchmark_table.md
          cat benchmark_table.md >> "${GITHUB_STEP_SUMMARY}"

      - name: Build wheel (packaging check)
        run: |
          python -m pip install --upgrade pip build
          python -m build --wheel

      - name: Validate wheel metadata
        run: |
          python -m pip install --upgrade twine
          python -m twine check dist/*

      - name: Install built wheel and run end-user smoke test
        run: |
          python -m pip install --force-reinstall dist/*.whl
          python - <<'PY'
          import numpy as np
          from quantkernel import QuantKernel, QK_CALL, QK_PUT

          qk = QuantKernel()
          bsm = qk.black_scholes_merton_price(100.0, 100.0, 1.0, 0.2, 0.03, 0.01, QK_CALL)
          am = qk.crr_price(100.0, 100.0, 1.0, 0.2, 0.03, 0.01, QK_PUT, 200, 1)
          heston = qk.heston_price_cf(100.0, 100.0, 1.0, 0.03, 0.01, 0.04, 2.0, 0.04, 0.5, -0.7, QK_CALL, 512, 100.0)
          batch = qk.black_scholes_merton_price_batch(
              np.array([100.0, 101.0]),
              np.array([100.0, 100.0]),
              np.array([1.0, 1.0]),
              np.array([0.2, 0.2]),
              np.array([0.03, 0.03]),
              np.array([0.01, 0.01]),
              np.array([QK_CALL, QK_PUT], dtype=np.int32),
          )
          assert bsm > 0.0 and am > 0.0 and heston > 0.0 and batch.shape == (2,)
          print("Wheel smoke test passed.")
          PY
